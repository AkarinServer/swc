name: Build SWC for RISC-V 64

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    # Run weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'
  workflow_run:
    # Trigger when sync workflow completes successfully
    workflows: ["Sync Upstream SWC"]
    types:
      - completed
    branches: [ main, master ]

jobs:
  build-riscv64:
    name: Build SWC Node.js bindings for RISC-V 64
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    # Only run if triggered by sync workflow (and it succeeded) or other events
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      github.event_name == 'push' ||
      github.event_name == 'pull_request' ||
      github.event_name == 'schedule'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup QEMU for RISC-V
        uses: docker/setup-qemu-action@v3
        with:
          platforms: riscv64

      - name: Build on RISCV64
        uses: uraimo/run-on-arch-action@v3
        with:
          arch: riscv64
          distro: ubuntu24.04
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          dockerRunArgs: |
            --volume "${{ github.workspace }}:/workspace"
          run: |
            # 更新系统
            apt-get update -qq
            apt-get install -y \
              build-essential \
              curl \
              wget \
              git \
              pkg-config \
              libssl-dev \
              ca-certificates \
              gnupg \
              python3 \
              python3-pip
            
            # 安装 Node.js (RISC-V 版本)
            NODE_VERSION="24.11.0"
            NODE_ARCH="riscv64"
            NODE_DIST="node-v${NODE_VERSION}-linux-${NODE_ARCH}"
            NODE_URL="https://github.com/gounthar/unofficial-builds/releases/download/v${NODE_VERSION}/${NODE_DIST}.tar.xz"
            
            cd /tmp
            echo "Downloading Node.js ${NODE_VERSION} for RISCV64..."
            wget -q "$NODE_URL" -O "${NODE_DIST}.tar.xz" || {
              echo "Error: Failed to download Node.js"
              exit 1
            }
            
            tar -xf "${NODE_DIST}.tar.xz"
            mv "${NODE_DIST}" /opt/nodejs
            export PATH="/opt/nodejs/bin:$PATH"
            ln -sf /opt/nodejs/bin/node /usr/local/bin/node
            ln -sf /opt/nodejs/bin/npm /usr/local/bin/npm
            ln -sf /opt/nodejs/bin/npx /usr/local/bin/npx
            
            echo "Node.js version: $(node --version)"
            echo "npm version: $(npm --version)"
            
            # 安装 Rust
            echo "Installing Rust..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            source $HOME/.cargo/env
            
            # 添加 RISC-V 目标
            rustup target add riscv64gc-unknown-linux-gnu
            echo "Rust version: $(rustc --version)"
            
            # 切换到工作目录
            cd /workspace
            echo "Current directory: $(pwd)"
            echo "Workspace contents:"
            ls -la
            
            # 检查项目结构
            if [ ! -d "packages/core" ]; then
              echo "Error: packages/core directory not found"
              echo "Available directories:"
              find . -maxdepth 2 -type d | head -20
              exit 1
            fi
            
            # 进入 packages/core 目录（这是 @swc/core 包）
            cd packages/core
            echo "Current directory: $(pwd)"
            echo "packages/core contents:"
            ls -la
            
            # 安装 Node.js 依赖
            # SWC 项目使用 Yarn workspace，需要启用 Corepack 来使用正确的 Yarn 版本
            echo "Installing Node.js dependencies..."
            cd /workspace
            
            # 启用 Corepack（Node.js 内置的包管理器版本管理工具）
            corepack enable || {
              echo "Warning: corepack enable failed, trying alternative method"
              npm install -g corepack
              corepack enable
            }
            
            # 使用 Yarn 安装依赖（Corepack 会自动使用 package.json 中指定的版本）
            if [ -f yarn.lock ]; then
              echo "Using Yarn to install dependencies..."
              yarn install --frozen-lockfile || yarn install
            elif [ -f package-lock.json ]; then
              echo "Using npm to install dependencies..."
              npm ci || npm install
            else
              echo "No lock file found, using Yarn..."
              yarn install || npm install
            fi
            
            # 设置环境变量
            export CARGO_BUILD_JOBS=$(nproc || echo 4)
            export CARGO_TARGET_DIR="/workspace/target"
            export CARGO_NET_RETRY=10
            export CARGO_HTTP_TIMEOUT=300
            
            # 进入 packages/core 目录进行构建
            cd /workspace/packages/core
            echo "Current directory: $(pwd)"
            
            # 构建 SWC Node.js bindings for RISC-V
            echo "Building SWC Node.js bindings for RISC-V..."
            echo "Using napi build command with RISC-V target..."
            
            # 使用 napi build 命令，指定 RISC-V 目标
            # 注意：napi build 需要指定 target，但可能需要先编译 TypeScript
            yarn build:ts || npm run build:ts || tsc -d || echo "TypeScript build skipped"
            
            # 使用 napi build 构建 RISC-V 目标
            # napi build 会自动检测目标平台，但我们需要明确指定
            npx napi build \
              --manifest-path ../../Cargo.toml \
              --target riscv64-unknown-linux-gnu \
              --platform \
              -p binding_core_node \
              --js ./binding.js \
              --dts ./binding.d.ts \
              --release \
              -o . || {
              echo "⚠ napi build failed, trying alternative method..."
              
              # 备用方法：先编译 Rust，然后手动构建
              cd /workspace
              echo "Building Rust crates for RISC-V..."
              cargo build --release --target riscv64gc-unknown-linux-gnu -p binding_core_node || {
                echo "Error: Failed to build Rust crates"
                exit 1
              }
              
              # 回到 packages/core
              cd packages/core
              
              # 尝试使用 napi-cli 从已编译的二进制文件生成绑定
              npx napi build \
                --manifest-path ../../Cargo.toml \
                --target riscv64-unknown-linux-gnu \
                -p binding_core_node \
                --js ./binding.js \
                --dts ./binding.d.ts \
                --release \
                -o . || {
                echo "Error: All build methods failed"
                exit 1
              }
            }
            
            # 查找生成的二进制文件
            echo "Searching for built binaries..."
            find /workspace -name "*.node" -type f 2>/dev/null | head -10
            find /workspace/target -name "*.node" -type f 2>/dev/null | head -10
            find . -name "*.node" -type f 2>/dev/null | head -10
            
            # 查找 binding.node 文件
            BINDING_NODE=""
            if [ -f "swc.linux-riscv64-gnu.node" ]; then
              BINDING_NODE="swc.linux-riscv64-gnu.node"
            elif [ -f "swc.linux-riscv64-musl.node" ]; then
              BINDING_NODE="swc.linux-riscv64-musl.node"
            elif [ -f "../../target/riscv64gc-unknown-linux-gnu/release/libbinding_core_node.so" ]; then
              # 如果是 .so 文件，需要重命名为 .node
              cp "../../target/riscv64gc-unknown-linux-gnu/release/libbinding_core_node.so" "swc.linux-riscv64-gnu.node"
              BINDING_NODE="swc.linux-riscv64-gnu.node"
            else
              # 尝试查找任何 .node 文件
              BINDING_NODE=$(find . -name "*.node" -type f | head -1)
              if [ -z "$BINDING_NODE" ]; then
                # 尝试查找 target 目录中的 .so 文件
                SO_FILE=$(find ../../target -name "libbinding_core_node.so" -type f | head -1)
                if [ -n "$SO_FILE" ]; then
                  cp "$SO_FILE" "swc.linux-riscv64-gnu.node"
                  BINDING_NODE="swc.linux-riscv64-gnu.node"
                fi
              fi
            fi
            
            if [ -n "$BINDING_NODE" ] && [ -f "$BINDING_NODE" ]; then
              echo "✓ Found binding.node: $BINDING_NODE"
              ls -lh "$BINDING_NODE"
              
              # 复制到工作目录根目录以便上传
              cp "$BINDING_NODE" /workspace/swc-riscv64.node
              echo "✓ Copied to /workspace/swc-riscv64.node"
            else
              echo "✗ Error: binding.node not found"
              echo "Searching in all locations:"
              find /workspace -name "*.node" -type f 2>/dev/null
              find /workspace -name "*.so" -type f 2>/dev/null | grep -i binding
              exit 1
            fi
            
            # 验证文件
            if [ -f "/workspace/swc-riscv64.node" ]; then
              echo "✓ Final binary file:"
              ls -lh /workspace/swc-riscv64.node
              file /workspace/swc-riscv64.node || true
            fi

      - name: Upload RISC-V binary
        uses: actions/upload-artifact@v4
        with:
          name: swc-riscv64-binding
          path: swc-riscv64.node
          retention-days: 90
          if-no-files-found: error

      - name: Create GitHub Release (if tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: swc-riscv64.node
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Successfully built SWC Node.js bindings for RISC-V 64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Binary file:** \`swc-riscv64.node\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Download:** Available as GitHub Actions artifact" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Usage:** Replace \`node_modules/@swc/core/binding.node\` with this file" >> $GITHUB_STEP_SUMMARY

